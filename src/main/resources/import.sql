--DDL Statements
DROP TABLE IF EXISTS line_items;
DROP TABLE IF EXISTS receipts;
DROP TABLE IF EXISTS product_identifiers;
DROP TABLE IF EXISTS products;
DROP TABLE IF EXISTS customers;
DROP TABLE IF EXISTS pos_systems;
DROP TABLE IF EXISTS stores;

CREATE TABLE stores
(
    id                      BIGINT GENERATED BY DEFAULT AS IDENTITY,
    vat_registration_number VARCHAR(255),
    name                    VARCHAR(255),
    address                 VARCHAR(255),
    store_logo_url			VARCHAR(255),
    PRIMARY KEY (id)
);

CREATE TABLE pos_systems
(
    id     BIGINT GENERATED BY DEFAULT AS IDENTITY,
    name   VARCHAR(255),
    version VARCHAR(255),
    PRIMARY KEY (id)
);

CREATE TABLE customers
(
    id              SERIAL PRIMARY KEY,
    name            VARCHAR(255),
    mobile_number   VARCHAR(255),
    email_address   VARCHAR(255),
    identifier_type VARCHAR(255) NOT NULL,
    CONSTRAINT unique_mobile_number UNIQUE (mobile_number),
    CONSTRAINT unique_email_address UNIQUE (email_address),
    CONSTRAINT check_identifier CHECK (
            (mobile_number IS NOT NULL AND email_address IS NULL AND identifier_type = 'mobile_number') OR
            (mobile_number IS NULL AND email_address IS NOT NULL AND identifier_type = 'email_address')
        )
);

CREATE TABLE products
(
    id            BIGINT GENERATED BY DEFAULT AS IDENTITY,
    name		  VARCHAR(255),
    description   VARCHAR(255),
    PRIMARY KEY (id)
);

CREATE TABLE product_identifiers
(
    id            BIGINT GENERATED BY DEFAULT AS IDENTITY,
    product_id    BIGINT NOT NULL REFERENCES products (id),
    store_id      BIGINT NOT NULL REFERENCES stores(id),
    pos_system_id BIGINT NOT NULL REFERENCES pos_systems (id),
    ean13         VARCHAR(13),
    universal_product_code VARCHAR(12),
    sku           VARCHAR(50),
    CONSTRAINT unique_sku_per_pos_system_per_store
        UNIQUE (pos_system_id, sku, store_id),
    PRIMARY KEY (id)
);

CREATE TABLE receipts
(
    id                BIGINT GENERATED BY DEFAULT AS IDENTITY,
    store_id          BIGINT,
    pos_system_id     BIGINT,
    customer_id       BIGINT,
    timestamp         TIMESTAMP NOT NULL,
    total_amount_paid NUMERIC(19, 2),
    PRIMARY KEY (id),
    CONSTRAINT fk_receipt_store FOREIGN KEY (store_id) REFERENCES stores (id),
    CONSTRAINT fk_receipt_pos_system FOREIGN KEY (pos_system_id) REFERENCES pos_systems (id),
    CONSTRAINT fk_receipt_customer FOREIGN KEY (customer_id) REFERENCES customers (id)
);

CREATE TABLE line_items
(
    id         BIGINT GENERATED BY DEFAULT AS IDENTITY,
    receipt_id BIGINT,
    product_id BIGINT,
    quantity   INTEGER,
    PRIMARY KEY (id),
    CONSTRAINT fk_receipt_item_receipt FOREIGN KEY (receipt_id) REFERENCES receipts (id),
    CONSTRAINT fk_receipt_item_product FOREIGN KEY (product_id) REFERENCES products (id)
);

--Sample Data--

INSERT INTO pos_systems (name, version)
VALUES ('InfoSys Point of Sale System', 'V1.00'),
       ('Oracle Point of Sale System', 'V3.00');

INSERT INTO stores (vat_registration_number, name, address, store_logo_url)
VALUES ('123456789', 'Woolworths', '123 Main Street Sandtoo', 'test_url'),
       ('987654321', 'Checkers', '456 Second Avenue Linden', 'test_url'),
       ('678765550', 'Pick n Pay', '456 Second Avenue Linden', 'test_url');

INSERT INTO customers (name, mobile_number, email_address, identifier_type)
VALUES ('Will Smith', '+27662012488', NULL, 'mobile_number'),
       ('Jane Doe', NULL, 'jane.doe@example.com', 'email_address');

INSERT INTO products (name, description)
VALUES ('Milk', 'Full Cream'),
       ('Bread','Brown'),
       ('Cheese', 'Cheddar'),
       ('Water', 'Sparkling');

INSERT INTO product_identifiers (product_id, store_id, pos_system_id, sku, ean13, universal_product_code)
VALUES (1, 1, 1, 'SKU123', null, null),
       (2, 2, 2, null, '1234567890123', null),
       (3, 2, 2, null, null, '34567890123');

INSERT INTO receipts (store_id, pos_system_id, customer_id, timestamp, total_amount_paid)
VALUES (1, 1, 1, '2023-05-01 10:30:00', 29.97),
       (2, 2, 2, '2023-05-02 15:45:00', 59.98);

INSERT INTO line_items (receipt_id, product_id, quantity)
VALUES (1, 1, 3),
       (2, 2, 2);